
package rohin.gameengine;

import java.awt.Graphics2D;
import java.util.*;

// Core game engine class.

public class ECSEngine extends ECSObject
{
    // @formatter:off
    
    // Constants
    
    public static final Boolean M_GAME_LOOP_DEFAULT_TARGET_ENABLED   = true;
    public static final double  M_GAME_LOOP_DEFAULT_FPS_TARGET       = 90;
    public static final int     M_GAME_LOOP_DEFAULT_LOOP_DELAY_FIXED = 1000;
    public static final int     M_GAME_LOOP_DEFAULT_LOOP_DELAY_MIN   = 5;
    
    // Fields.
    
    // Game engine parameters.

    private List <ECSSystem> systems;                   // List of game entities.
    private List <ECSEntity> entities;                  // List of game systems.
    private CommandInvoker   commandInvoker;            // Command invocation manager.
    
    private Graphics2D       graphicsHandle;            // Handle to the graphics context we will be drawing on.
    private Boolean          loggingEnabled;            // logging switch.
    private ConsoleLogger    logger;                    // Console logger.
    private String           resourcePath;              // Disk location for all game assets. e.g. Images, sounds, vector models, etc.
    
    // Game loop management.
    
    private Boolean          loopRunning;               // Loop state. Set to true to run the game loop. Set to false to exit the game loop.
    private int              loopDelayFixed;            // Game loop, frame rate regulator. Fixed delay, measured in ms.
    private int              loopDelayVariable;         // Game loop, frame rate regulator. Dynamic delay, that adjusts to maintain target FPS.    
    private int              loopDelayMin;              // Minimum loop iteration delay.
    private double           fpsTarget;                 // Target Frames Per Second.
    private Boolean          fpsTargetEnabled;          // Choose whether to use a fixed loop delay, or a target FPS.
    
    // Game loop monitoring
    
    private double           fps;                       // Measured frames Per Second. (Animation frequency).
    private long             loopIterationTime;         // Loop iteration time. Used for display and debugging.
    
    // Accessors and mutators.

    public List <ECSSystem> GetSystems         () { return this.systems;          }
    public List <ECSEntity> GetEntities        () { return this.entities;         }
    public Graphics2D       GetGrahicsHandle   () { return this.graphicsHandle;   }
    public Boolean          IsloggingEnabled   () { return this.loggingEnabled;   }
    public String           getResourcePath    () { return this.resourcePath;     }
    public Boolean          IsLoopRunning      () { return this.loopRunning;      }
    public Boolean          IsFPSTargetEnabled () { return this.fpsTargetEnabled; }    
    public int              getLoopDelayFixed  () { return this.loopDelayFixed;   }
    public int              getLoopDelayMin    () { return this.loopDelayMin;     }
    public double           getFPSTarget       () { return this.fpsTarget;        }        
    public CommandInvoker   getCommandInvoker  () { return this.commandInvoker;   }
    
    public void setCommandInvoker   ( CommandInvoker commandInvoker   ) { this.commandInvoker   = commandInvoker;   }    
    public void SetGraphicsHandle   ( Graphics2D     graphicsHandle   ) { this.graphicsHandle   = graphicsHandle;   }
    public void SetloggingEnabled   ( Boolean        loggingEnabled   ) { this.loggingEnabled   = loggingEnabled;   }
    public void SetResourcePath     ( String         resourcePath     ) { this.resourcePath     = resourcePath;     }
    public void SetLoopRunning      ( Boolean        loopRunning      ) { this.loopRunning      = loopRunning;      }
    public void setLoopDelayFixed   ( int            loopDelayFixed   ) { this.loopDelayFixed   = loopDelayFixed;   }
    public void setLoopDelayMin     ( int            loopDelayMin     ) { this.loopDelayMin     = loopDelayMin;     }
    public void setFPSTargetEnabled ( Boolean        fpsTargetEnabled ) { this.fpsTargetEnabled = fpsTargetEnabled; }
    public void setFPSTarget        ( double         fpsTarget        ) { this.fpsTarget        = fpsTarget;        }

    // Constructors.

    public ECSEngine ()                  { Initialize ( null  ); }
    public ECSEngine ( ECSEngine owner ) { Initialize ( owner ); }    
    
    // Initialize
    
    private void Initialize ( ECSEngine owner )
    {
        // Initialize game engine parameters.
        
        this.owner          = owner;
        this.systems        = new ArrayList <ECSSystem> ();
        this.entities       = new ArrayList <ECSEntity> ();
        this.loggingEnabled = true;
        this.logger         = new ConsoleLogger ( this, this.loggingEnabled );
        
        // Initialize game loop parameters.
        
        this.loopRunning       = true;
        this.fpsTargetEnabled  = M_GAME_LOOP_DEFAULT_TARGET_ENABLED;
        this.fpsTarget         = M_GAME_LOOP_DEFAULT_FPS_TARGET;
        this.loopDelayFixed    = M_GAME_LOOP_DEFAULT_LOOP_DELAY_FIXED;       
        this.loopDelayMin      = M_GAME_LOOP_DEFAULT_LOOP_DELAY_MIN;
        this.loopDelayVariable = 0;
        
        // Initialize loop monitoring points.
                
        this.loopIterationTime = 0;
        this.fps               = 0;                  
    }
    
    // @formatter:on

    // Methods.

    // --------------------------------------------------------------------------------------------------------------------------------------------------------
    // Game loop.
    // --------------------------------------------------------------------------------------------------------------------------------------------------------

    public void Run ()
    {
        this.logger.Log ();
        
        long start = 0;
        long stop  = 0;
        long t     = 0;

        this.loopRunning = true;

        while ( this.loopRunning )
        {
            start = System.currentTimeMillis ();        // Start the clock.

            for ( ECSSystem system : this.systems )     // Loop through all game systems.
            {
                system.Update ( t, this );              // Call Update on each of them. 
            }
            
            RegulateFrameRate ();                       // Give the CPU some time to do other things other than spin the loop.

            stop = System.currentTimeMillis ();         // Stop the clock.
            t    = stop - start;                        // Calculate the lap time for this iteration.
        }
    }
    
    // --------------------------------------------------------------------------------------------------------------------------------------------------------
    // Add system.
    // --------------------------------------------------------------------------------------------------------------------------------------------------------
    
    public void AddSystem ( ECSSystem system )
    {
        this.systems.add ( system );
    }
    
    // --------------------------------------------------------------------------------------------------------------------------------------------------------
    // Add entity.
    // --------------------------------------------------------------------------------------------------------------------------------------------------------
    
    public void AddEntity ( ECSEntity entity )
    {
        this.entities.add ( entity );
    }
        
    public void AddEntity ( int index, ECSEntity entity )
    {
        this.entities.add ( index, entity );
    }
    
    // --------------------------------------------------------------------------------------------------------------------------------------------------------    
    // Variable frame rate regulation delay.
    //
    // Used to implement a variable period frame rate regulation delay, that
    // attempts to normalize the frame rate to a specified target frame rate.
    // 
    // The target frame rate is specified internally through, fpsTarget.    
    // --------------------------------------------------------------------------------------------------------------------------------------------------------

    public void RegulateFrameRate ()
    {
        if ( this.fpsTargetEnabled )
        {
            // Calculate dynamic period loop delay.
            //
            // - If we are spinning faster than the target FPS, then delay the loop for the remaining time, until target FPS is reached..
            // - If we are spinning slower than the target FPS, then just force the minimum delay.
            //
            //   Note:
            //   We don't allow a minimum delay of zero, for risk of the game loop hogging the the CPU and potentially hanging the main application thread.                                   

            if ( this.fpsTarget > 0.0 )
            {
                this.loopDelayVariable = ( int ) ( 1000.0 / this.fpsTarget );
            }
            else
            {
                this.loopDelayVariable = this.loopDelayMin;
            }

            Delay ( this.loopDelayVariable );             
        }
        else
        {
            // Fixed period loop delay.

            Delay ( this.loopDelayFixed );
        }
    }
    
    // --------------------------------------------------------------------------------------------------------------------------------------------------------    
    // Frame rate delay.
    // 
    // Used to implement a fixed period frame rate delay.
    // 
    // Arguments:
    // - period
    //   The period to dealy in milliseconds.
    // --------------------------------------------------------------------------------------------------------------------------------------------------------
    
    public void Delay ( long period )
    {           
        try
        {
            Thread.sleep ( period );
        }
        catch ( InterruptedException e )
        {
            e.printStackTrace ();
        }
    }    
}











